<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Context (gccjit.Gccjit.Context)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">gccjit</a> &#x00BB; <a href="../index.html">Gccjit</a> &#x00BB; Context</nav><header class="odoc-preamble"><h1>Module <code><span>Gccjit.Context</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#lifetime-management">Lifetime-management</a></li><li><a href="#thread-safety">Thread-safety</a></li><li><a href="#debugging">Debugging</a></li><li><a href="#context-options">Context Options</a></li><li><a href="#compilation">Compilation</a></li></ul></nav><div class="odoc-content"><h2 id="lifetime-management"><a href="#lifetime-management" class="anchor"></a>Lifetime-management</h2><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="../index.html#type-context">context</a></span></code></div><div class="spec-doc"><p>Creates a new <a href="../index.html#type-context"><code>context</code></a> instance, which is independent of any others that may be present within this process.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-release"><a href="#val-release" class="anchor"></a><code><span><span class="keyword">val</span> release : <span><a href="../index.html#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Releases all resources associated with the given context. Both the context itself and all of its object instances are cleared up. It should be called exactly once on a given context.</p><p>It is invalid to use the context or any of its <em>contextual</em> objects after calling this.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create_child"><a href="#val-create_child" class="anchor"></a><code><span><span class="keyword">val</span> create_child : <span><a href="../index.html#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> <a href="../index.html#type-context">context</a></span></code></div><div class="spec-doc"><p>Given an existing JIT context, create a child context.</p><ul><li>The child inherits a copy of all option-settings from the parent.</li><li>The child can reference objects created within the parent, but not vice-versa.</li><li>The lifetime of the child context must be bounded by that of the parent: you should release a child context before releasing the parent context.</li></ul><p>If you use a function from a parent context within a child context, you have to compile the parent context before you can compile the child context, and the <a href="../index.html#type-result"><code>result</code></a> of the parent context must outlive the <a href="../index.html#type-result"><code>result</code></a> of the child context.</p><p>This allows caching of shared initializations. For example, you could create types and declarations of global functions in a parent context once within a process, and then create child contexts whenever a function or loop becomes hot. Each such child context can be used for JIT-compiling just one function or loop, but can reference types and helper functions created within the parent context.</p><p>Contexts can be arbitrarily nested, provided the above rules are followed, but it's probably not worth going above 2 or 3 levels, and there will likely be a performance hit for such nesting.</p></div></div><h2 id="thread-safety"><a href="#thread-safety" class="anchor"></a>Thread-safety</h2><p>Instances of <a href="../index.html#type-context"><code>context</code></a> created via <a href="#val-create"><code>create</code></a> are independent from each other: only one thread may use a given context at once, but multiple threads could each have their own contexts without needing locks.</p><p>Contexts created via <a href="#val-create_child"><code>create_child</code></a> are related to their parent context. They can be partitioned by their ultimate ancestor into independent &quot;family trees&quot;. Only one thread within a process may use a given &quot;family tree&quot; of such contexts at once, and if you're using multiple threads you should provide your own locking around entire such context partitions.</p><h2 id="debugging"><a href="#debugging" class="anchor"></a>Debugging</h2><div class="odoc-spec"><div class="spec value anchored" id="val-dump_to_file"><a href="#val-dump_to_file" class="anchor"></a><code><span><span class="keyword">val</span> dump_to_file : <span><a href="../index.html#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?update_locs</span>:bool <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Dump a C-like representation to the given path, describing what's been set up on the context. If <code>~update_locs</code> true, then also set up <a href="../index.html#type-location"><code>location</code></a> information throughout the context, pointing at the dump file as if it were a source file. This may be of use in conjunction with <a href="#type-context_option" title="Context.context_option"><code>Debuginfo</code></a> to allow stepping through the code in a debugger.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_logfile"><a href="#val-set_logfile" class="anchor"></a><code><span><span class="keyword">val</span> set_logfile : <span><a href="../index.html#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="xref-unresolved">Unix</span>.file_descr option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_logfile ctx logfile</code> enable ongoing logging of the context <code>ctx</code>'s activity to the given file descriptor <code>logfile</code>. Examples of information logged include:</p><ul><li>API calls</li><li>the various steps involved within compilation</li><li>activity on any <a href="../index.html#type-result"><code>result</code></a> instances created by the context</li><li>activity within any child contexts</li><li>An example of a log can be seen here, though the precise format and kinds of information logged is subject to change.</li></ul><p>The caller remains responsible for closing <code>logfile</code>, and it must not be closed until all users are released. In particular, note that child <a href="../index.html#type-context" title="context">contexts</a> and <a href="../index.html#type-result"><code>result</code></a> instances created by the <a href="../index.html#type-context"><code>context</code></a> will use <code>logfile</code>.</p><p>There may a performance cost for logging.</p><p>You can turn off logging on <code>ctx</code> by passing <code>None</code> for <code>logfile</code>. Doing so only affects the context; it does not affect child <a href="../index.html#type-context" title="context">contexts</a> or <a href="../index.html#type-result"><code>result</code></a> instances already created by the <a href="../index.html#type-context"><code>context</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-dump_reproducer_to_file"><a href="#val-dump_reproducer_to_file" class="anchor"></a><code><span><span class="keyword">val</span> dump_reproducer_to_file : <span><a href="../index.html#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Write C source code into path that can be compiled into a self-contained executable (i.e. with <code>libgccjit</code> as the only dependency). The generated code will attempt to replay the API calls that have been made into the given context.</p><p>This may be useful when debugging the library or client code, for reducing a complicated recipe for reproducing a bug into a simpler form. For example, consider client code that parses some source file into some internal representation, and then walks this IR, calling into <code>libgccjit</code>. If this encounters a bug, a call to <a href="#val-dump_reproducer_to_file"><code>dump_reproducer_to_file</code></a> will write out C code for a much simpler executable that performs the equivalent calls into <code>libgccjit</code>, without needing the client code and its data.</p><p>Typically you need to supply <code>&quot;-Wno-unused-variable&quot;</code> when compiling the generated file (since the result of each API call is assigned to a unique variable within the generated C source, and not all are necessarily then used).</p></div></div><h2 id="context-options"><a href="#context-options" class="anchor"></a>Context Options</h2><div class="odoc-spec"><div class="spec type anchored" id="type-context_option"><a href="#type-context_option" class="anchor"></a><code><span><span class="keyword">type</span> <span>_ context_option</span></span><span> = </span></code><ol><li id="type-context_option.Progname" class="def variant constructor anchored"><a href="#type-context_option.Progname" class="anchor"></a><code><span>| </span><span><span class="constructor">Progname</span> : <span>string <a href="#type-context_option">context_option</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The name of the program, for used as a prefix when printing error messages to stderr. If not set, <code>&quot;libgccjit.so&quot;</code> is used.</p><span class="comment-delim">*)</span></div></li><li id="type-context_option.Optimization_level" class="def variant constructor anchored"><a href="#type-context_option.Optimization_level" class="anchor"></a><code><span>| </span><span><span class="constructor">Optimization_level</span> : <span>int <a href="#type-context_option">context_option</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>How much to optimize the code. Valid values are <code>0-3</code>, corresponding to GCC's command-line options -O0 through -O3.</p><p>The default value is 0 (unoptimized).</p><span class="comment-delim">*)</span></div></li><li id="type-context_option.Debuginfo" class="def variant constructor anchored"><a href="#type-context_option.Debuginfo" class="anchor"></a><code><span>| </span><span><span class="constructor">Debuginfo</span> : <span>bool <a href="#type-context_option">context_option</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>If <code>true</code>, <a href="#val-compile"><code>Context.compile</code></a> will attempt to do the right thing so that if you attach a debugger to the process, it will be able to inspect variables and step through your code. Note that you can't step through code unless you set up source location information for the code (by creating and passing in <a href="../index.html#type-location"><code>location</code></a> instances).</p><span class="comment-delim">*)</span></div></li><li id="type-context_option.Dump_initial_tree" class="def variant constructor anchored"><a href="#type-context_option.Dump_initial_tree" class="anchor"></a><code><span>| </span><span><span class="constructor">Dump_initial_tree</span> : <span>bool <a href="#type-context_option">context_option</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>If <code>true</code>, <a href="#val-compile"><code>Context.compile</code></a> will dump its initial &quot;tree&quot; representation of your code to <code>stderr</code> (before any optimizations).</p><span class="comment-delim">*)</span></div></li><li id="type-context_option.Dump_initial_gimple" class="def variant constructor anchored"><a href="#type-context_option.Dump_initial_gimple" class="anchor"></a><code><span>| </span><span><span class="constructor">Dump_initial_gimple</span> : <span>bool <a href="#type-context_option">context_option</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>If <code>true</code>, <a href="#val-compile"><code>Context.compile</code></a> will dump the &quot;gimple&quot; representation of your code to stderr, before any optimizations are performed. The dump resembles C code.</p><span class="comment-delim">*)</span></div></li><li id="type-context_option.Dump_generated_code" class="def variant constructor anchored"><a href="#type-context_option.Dump_generated_code" class="anchor"></a><code><span>| </span><span><span class="constructor">Dump_generated_code</span> : <span>bool <a href="#type-context_option">context_option</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>If <code>true</code>, <a href="#val-compile"><code>Context.compile</code></a> will dump the final generated code to stderr, in the form of assembly language.</p><span class="comment-delim">*)</span></div></li><li id="type-context_option.Dump_summary" class="def variant constructor anchored"><a href="#type-context_option.Dump_summary" class="anchor"></a><code><span>| </span><span><span class="constructor">Dump_summary</span> : <span>bool <a href="#type-context_option">context_option</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>If <code>true</code>, <a href="#val-compile"><code>Context.compile</code></a> will print information to stderr on the actions it is performing, followed by a profile showing the time taken and memory usage of each phase.</p><span class="comment-delim">*)</span></div></li><li id="type-context_option.Dump_everything" class="def variant constructor anchored"><a href="#type-context_option.Dump_everything" class="anchor"></a><code><span>| </span><span><span class="constructor">Dump_everything</span> : <span>bool <a href="#type-context_option">context_option</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>If <code>true</code>, <a href="#val-compile"><code>Context.compile</code></a> will dump copious amount of information on what it's doing to various files within a temporary directory. Use <code>Keep_intermediates</code> (see below) to see the results. The files are intended to be human-readable, but the exact files and their formats are subject to change.</p><span class="comment-delim">*)</span></div></li><li id="type-context_option.Selfcheck_gc" class="def variant constructor anchored"><a href="#type-context_option.Selfcheck_gc" class="anchor"></a><code><span>| </span><span><span class="constructor">Selfcheck_gc</span> : <span>bool <a href="#type-context_option">context_option</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>If <code>true</code>, <code>libgccjit</code> will aggressively run its garbage collector, to shake out bugs (greatly slowing down the compile). This is likely to only be of interest to developers *of* the library. It is used when running the selftest suite.</p><span class="comment-delim">*)</span></div></li><li id="type-context_option.Keep_intermediates" class="def variant constructor anchored"><a href="#type-context_option.Keep_intermediates" class="anchor"></a><code><span>| </span><span><span class="constructor">Keep_intermediates</span> : <span>bool <a href="#type-context_option">context_option</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>If <code>true</code>, <a href="#val-release"><code>Context.release</code></a> will not clean up intermediate files written to the filesystem, and will display their location on stderr.</p><span class="comment-delim">*)</span></div></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_option"><a href="#val-set_option" class="anchor"></a><code><span><span class="keyword">val</span> set_option : <span><a href="../index.html#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-context_option">context_option</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_option ctx opt v</code> sets the <a href="#type-context_option"><code>Context.context_option</code></a> <code>opt</code> of <code>ctx</code> to <code>v</code>.</p></div></div><h2 id="compilation"><a href="#compilation" class="anchor"></a>Compilation</h2><p>Once populated, a <a href="../index.html#type-context"><code>context</code></a> can be compiled to machine code, either in-memory via <a href="#val-compile"><code>compile</code></a> or to disk via <a href="#val-compile_to_file"><code>compile_to_file</code></a>.</p><p>You can compile a context multiple times (using either form of compilation), although any errors that occur on the context will prevent any future compilation of that context.</p><div class="odoc-spec"><div class="spec value anchored" id="val-compile"><a href="#val-compile" class="anchor"></a><code><span><span class="keyword">val</span> compile : <span><a href="../index.html#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> <a href="../index.html#type-result">result</a></span></code></div><div class="spec-doc"><p>This calls into GCC and builds the code, returning a <a href="../index.html#type-result"><code>result</code></a>. See <a href="../index.html#inmemory" title="inmemory">In-memory compilation</a>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-output_kind"><a href="#type-output_kind" class="anchor"></a><code><span><span class="keyword">type</span> output_kind</span><span> = </span></code><ol><li id="type-output_kind.Assembler" class="def variant constructor anchored"><a href="#type-output_kind.Assembler" class="anchor"></a><code><span>| </span><span><span class="constructor">Assembler</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Compile the context to an assembly file.</p><span class="comment-delim">*)</span></div></li><li id="type-output_kind.Object_file" class="def variant constructor anchored"><a href="#type-output_kind.Object_file" class="anchor"></a><code><span>| </span><span><span class="constructor">Object_file</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Compile the context to an object file.</p><span class="comment-delim">*)</span></div></li><li id="type-output_kind.Dynamic_library" class="def variant constructor anchored"><a href="#type-output_kind.Dynamic_library" class="anchor"></a><code><span>| </span><span><span class="constructor">Dynamic_library</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Compile the context to a dynamic library.</p><span class="comment-delim">*)</span></div></li><li id="type-output_kind.Executable" class="def variant constructor anchored"><a href="#type-output_kind.Executable" class="anchor"></a><code><span>| </span><span><span class="constructor">Executable</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Compile the context to an executable.</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>Kinds of ahead-of-time compilation, for use with <a href="#val-compile_to_file"><code>compile_to_file</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-compile_to_file"><a href="#val-compile_to_file" class="anchor"></a><code><span><span class="keyword">val</span> compile_to_file : <span><a href="../index.html#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-output_kind">output_kind</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Compile the context to a file of the given kind. This can be called more that once on a given context, although any errors that occur will block further compilation.</p></div></div></div></body></html>
